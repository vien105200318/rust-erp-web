<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Rust Discord Clone</title>
    <style>
        :root {
            --bg-tertiary: #202225;
            --bg-secondary: #2f3136;
            --bg-primary: #36393f;
            --text-normal: #dcddde;
            --text-muted: #72767d;
            --accent: #5865f2;
            --accent-hover: #4752c4;
            --danger: #ed4245;
            --channel-hover: #34373c;
            --channel-selected: #393c43;
        }
        body {
            font-family: 'Segoe UI', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-normal);
            margin: 0; height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* Login Form */
        #auth-screen { background-color: var(--bg-secondary); padding: 30px; border-radius: 5px; width: 400px; text-align: center; box-shadow: 0 2px 10px 0 rgba(0,0,0,0.2); }
        input { width: 100%; padding: 10px; margin: 10px 0; border-radius: 3px; border: 1px solid #202225; background-color: var(--bg-tertiary); color: white; box-sizing: border-box; transition: border-color .2s ease-in-out; }
        input:focus { border-color: var(--accent); outline: none; }
        button { width: 100%; padding: 10px; border-radius: 3px; border: none; cursor: pointer; font-weight: bold; margin-top: 10px; transition: background-color .17s ease; color: white; }
        .btn-primary { background-color: var(--accent); }
        .btn-primary:hover { background-color: var(--accent-hover); }
        .btn-secondary { background-color: transparent; color: var(--accent); margin-top: 5px; }
        .btn-secondary:hover { text-decoration: underline; }

        /* Main Layout (3 Cột) */
        #app-screen { display: none; width: 100%; height: 100%; display: flex; }

        /* Cột 1: Kênh */
        #sidebar { width: 240px; background-color: var(--bg-secondary); display: flex; flex-direction: column; padding-top: 10px; border-right: 1px solid var(--bg-tertiary); }
        .sidebar-header { padding: 0 16px; margin-bottom: 8px; font-weight: bold; color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
        .channel-item { padding: 8px 16px; margin: 1px 8px; border-radius: 4px; cursor: pointer; color: #8e9297; font-weight: 500; display: flex; align-items: center; }
        .channel-item:hover { background-color: var(--channel-hover); color: var(--text-normal); }
        .channel-item.active { background-color: var(--channel-selected); color: white; }
        .hash-symbol { color: var(--text-muted); margin-right: 6px; font-size: 20px; }

        /* Cột 2: Chat Chính */
        #main-chat { flex: 1; display: flex; flex-direction: column; background-color: var(--bg-primary); min-width: 0; }
        header { padding: 12px 16px; border-bottom: 1px solid #26272d; font-weight: bold; display: flex; align-items: center; background-color: var(--bg-primary); box-shadow: 0 1px 2px rgba(0,0,0,0.02); height: 48px; box-sizing: border-box; }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 4px; }
        #chat-container::-webkit-scrollbar { width: 8px; background-color: #2e3338; }
        #chat-container::-webkit-scrollbar-thumb { background-color: #202225; border-radius: 4px; }

        /* Message Styles */
        .message { margin-top: 10px; display: flex; padding: 2px 0; }
        .message:hover { background-color: rgba(4, 4, 5, 0.07); }
        .avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 16px; cursor: pointer; background-color: var(--bg-tertiary); }
        .msg-content { display: flex; flex-direction: column; justify-content: center; }
        .msg-header { display: flex; align-items: baseline; margin-bottom: 4px; }
        .username { color: white; font-weight: 500; margin-right: 8px; cursor: pointer; font-size: 1rem; }
        .username:hover { text-decoration: underline; }
        .msg-text { color: var(--text-normal); font-size: 0.95rem; word-break: break-word; line-height: 1.375rem; }

        /* Input Area */
        #input-area { padding: 0 16px 24px; background-color: var(--bg-primary); }
        .input-wrapper { background-color: #40444b; border-radius: 8px; padding: 0 16px; display: flex; align-items: center; }
        .input-wrapper input { background: transparent; border: none; padding: 12px 0; color: var(--text-normal); font-size: 1rem; width: 100%; }
        .input-wrapper input:focus { outline: none; }

        /* Cột 3: Danh sách thành viên (MỚI) */
        #members-list { width: 240px; background-color: var(--bg-secondary); padding: 20px 10px; display: flex; flex-direction: column; gap: 5px; border-left: 1px solid var(--bg-tertiary); overflow-y: auto; }
        .member-header { font-weight: bold; color: var(--text-muted); font-size: 12px; text-transform: uppercase; margin-bottom: 10px; padding-left: 10px; }
        .member-item { display: flex; align-items: center; padding: 6px 10px; border-radius: 4px; cursor: pointer; color: #8e9297; opacity: 0.9; }
        .member-item:hover { background-color: var(--channel-hover); color: var(--text-normal); opacity: 1; }
        .member-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; }
        .member-name { font-weight: 500; }

        /* User control panel (Góc dưới trái) */
        .user-panel { background-color: #292b2f; padding: 10px; display: flex; align-items: center; margin-top: auto; }
        .user-panel-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; background: grey; }
        .user-panel-info { flex: 1; font-size: 14px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; }
        .btn-logout { background: transparent; color: var(--danger); font-size: 12px; border: 1px solid var(--danger); width: auto; padding: 4px 8px; margin: 0; }
        .btn-logout:hover { background: var(--danger); color: white; }
    </style>
</head>
<body>

<div id="auth-screen">
    <h2 id="form-title" style="color: white; margin-bottom: 8px;">Chào mừng trở lại!</h2>
    <p style="color: #b9bbbe; margin-top: 0;">Rất vui được gặp lại bạn!</p>
    <input type="text" id="username" placeholder="Tên đăng nhập">
    <input type="password" id="password" placeholder="Mật khẩu">
    <button class="btn-primary" onclick="handleAuth()" id="btn-submit">Đăng Nhập</button>
    <button class="btn-secondary" onclick="toggleMode()" id="btn-toggle">Cần một tài khoản? Đăng ký</button>
    <p id="error-msg" style="color: var(--danger); font-size: 14px; margin-top: 10px;"></p>
</div>

<div id="app-screen">
    <div id="sidebar">
        <div class="sidebar-header">Text Channels</div>
        <div id="channel-list"></div>

        <div class="user-panel">
            <img id="my-avatar" class="user-panel-avatar" src="">
            <div class="user-panel-info" id="my-username">User</div>
            <button class="btn-logout" onclick="logout()">X</button>
        </div>
    </div>

    <div id="main-chat">
        <header>
            <span style="font-size: 24px; color: var(--text-muted); margin-right: 8px;">#</span>
            <span id="current-channel-name" style="color: white;">general</span>
        </header>

        <div id="chat-container"></div>

        <div id="input-area">
            <div class="input-wrapper">
                <input type="text" id="msgInput" placeholder="Nhập tin nhắn..." onkeydown="if(event.key==='Enter') sendMsg()">
            </div>
        </div>
    </div>

    <div id="members-list">
        <div class="member-header">Members</div>
        <div id="members-container">Loading...</div>
    </div>
</div>

<script>
    // Cấu hình
    const API_URL = "";
    let isLoginMode = true;
    let currentUser = null;
    let token = localStorage.getItem('token');
    let ws = null;
    let currentChannelId = 1;

    if (token) {
        currentUser = localStorage.getItem('username');
        showChatScreen();
    }

    // --- HÀM TIỆN ÍCH ---
    // Tạo avatar ngẫu nhiên dựa trên tên (Dùng DiceBear API)
    function getAvatarUrl(username) {
        return `https://api.dicebear.com/9.x/adventurer/svg?seed=${username}`;
    }

    // --- LOGIC AUTH ---
    function toggleMode() {
        isLoginMode = !isLoginMode;
        document.getElementById('form-title').innerText = isLoginMode ? "Chào mừng trở lại!" : "Tạo tài khoản";
        document.getElementById('btn-submit').innerText = isLoginMode ? "Đăng Nhập" : "Đăng Ký";
        document.getElementById('btn-toggle').innerText = isLoginMode ? "Cần một tài khoản? Đăng ký" : "Đã có tài khoản? Đăng nhập";
    }

    async function handleAuth() {
        const u = document.getElementById('username').value;
        const p = document.getElementById('password').value;
        const endpoint = isLoginMode ? '/login' : '/register';

        try {
            const res = await fetch(endpoint, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: u, password: p })
            });
            if (!res.ok) { document.getElementById('error-msg').innerText = await res.text(); return; }

            if (isLoginMode) {
                const data = await res.json();
                localStorage.setItem('token', data.token);
                localStorage.setItem('username', data.username);
                currentUser = data.username; token = data.token;
                showChatScreen();
            } else {
                alert("Đăng ký thành công!"); toggleMode();
            }
        } catch (err) { console.error(err); }
    }

    function logout() { localStorage.clear(); location.reload(); }

    // --- APP LOGIC ---
    function showChatScreen() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app-screen').style.display = 'flex';

        // Set thông tin cá nhân góc dưới trái
        document.getElementById('my-username').innerText = currentUser;
        document.getElementById('my-avatar').src = getAvatarUrl(currentUser);

        loadChannels();
        loadMembers(); // <--- Load danh sách thành viên
        connectWebSocket();
    }

    async function loadChannels() {
        const res = await fetch('/channels', { headers: { 'Authorization': 'Bearer ' + token } });
        const channels = await res.json();
        const listDiv = document.getElementById('channel-list');
        listDiv.innerHTML = '';

        channels.forEach((c, index) => {
            const div = document.createElement('div');
            div.className = 'channel-item';
            div.innerHTML = `<span class="hash-symbol">#</span> ${c.name}`;
            div.onclick = () => switchChannel(c.id, c.name, div);
            if (index === 0 && currentChannelId === 1) { // Auto select first
                currentChannelId = c.id;
                div.classList.add('active');
                document.getElementById('current-channel-name').innerText = c.name;
                loadHistory(c.id);
            }
            listDiv.appendChild(div);
        });
    }

    async function loadMembers() {
        try {
            const res = await fetch('/users', { headers: { 'Authorization': 'Bearer ' + token } });
            const users = await res.json();
            const container = document.getElementById('members-container');
            container.innerHTML = '';
            users.forEach(u => {
                const div = document.createElement('div');
                div.className = 'member-item';
                div.innerHTML = `
                        <img class="member-avatar" src="${getAvatarUrl(u.username)}">
                        <span class="member-name">${u.username}</span>
                    `;
                container.appendChild(div);
            });
        } catch (e) { console.error(e); }
    }

    async function switchChannel(id, name, element) {
        currentChannelId = id;
        document.getElementById('current-channel-name').innerText = name;
        document.querySelectorAll('.channel-item').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
        document.getElementById('chat-container').innerHTML = '';
        loadHistory(id);
    }

    async function loadHistory(channelId) {
        const res = await fetch(`/history?channel_id=${channelId}`, {
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const msgs = await res.json();
        msgs.forEach(m => appendMessage(m.username, m.content));
    }

    function connectWebSocket() {
        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
        ws = new WebSocket(protocol + "//" + location.host + "/ws?token=" + token);
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            if (data.channel_id === currentChannelId) {
                appendMessage(data.username, data.content);
            }
        };
        ws.onclose = () => setTimeout(connectWebSocket, 3000); // Auto reconnect
    }

    function sendMsg() {
        const input = document.getElementById('msgInput');
        const text = input.value;
        if (text && ws) {
            const payload = JSON.stringify({ channel_id: currentChannelId, content: text });
            ws.send(payload);
            input.value = '';
        }
    }

    function appendMessage(user, text) {
        const container = document.getElementById('chat-container');
        const div = document.createElement('div');
        div.className = 'message';
        // Layout tin nhắn kiểu Discord: Avatar bên trái, Tên + Nội dung bên phải
        div.innerHTML = `
                <img class="avatar" src="${getAvatarUrl(user)}">
                <div class="msg-content">
                    <div class="msg-header">
                        <span class="username">${user}</span>
                    </div>
                    <div class="msg-text">${text}</div>
                </div>
            `;
        container.appendChild(div);
        container.scrollTop = container.scrollHeight;
    }
</script>
</body>
</html>